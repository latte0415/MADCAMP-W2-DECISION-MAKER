from typing import List
from uuid import UUID
from fastapi import APIRouter, Depends, status
from sqlalchemy.orm import Session

from app.models import User
from app.services.event import EventService
from app.services.event.membership_service import MembershipService
from app.services.event.proposal_service import ProposalService
from app.services.event.comment_service import CommentService
from app.schemas.event import (
    EventCreateRequest,
    EventResponse,
    EntranceCodeCheckRequest,
    EntranceCodeCheckResponse,
    EntranceCodeGenerateResponse,
    EntranceCodeEntryRequest,
    EventEntryResponse,
    EventListItemResponse,
    EventOverviewResponse,
    EventUpdateRequest,
    MembershipResponse,
    BulkMembershipResponse,
    EventSettingResponse,
    MembershipListItemResponse,
    EventDetailResponse,
    AssumptionProposalCreateRequest,
    AssumptionProposalResponse,
    AssumptionProposalVoteResponse,
    CriteriaProposalCreateRequest,
    CriteriaProposalResponse,
    CriteriaProposalVoteResponse,
    ConclusionProposalCreateRequest,
    ConclusionProposalResponse,
    ConclusionProposalVoteResponse,
)
from app.schemas.event.comment import (
    CommentCreateRequest,
    CommentUpdateRequest,
    CommentResponse,
    CommentCountResponse,
    CommentCreatorInfo,
)
from app.dependencies.auth import get_current_user
from app.dependencies.services import (
    get_event_service,
    get_membership_service,
    get_proposal_service,
    get_comment_service,
)


router = APIRouter()


# ============================================================================
# Home (3-0-0) 관련 API
# ============================================================================

@router.get("/events/participated", response_model=List[EventListItemResponse])
def get_events_participated(
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
) -> List[EventListItemResponse]:
    """
    사용자가 참가한 이벤트 목록 조회 API
    - event_membership에서 조인해서 속한 event만 반환
    - 참가 인원, 관리자 정보, 멤버십 상태 포함
    """
    return event_service.get_events_participated(current_user.id)


# ============================================================================
# Event_Creation (3-2-0) 관련 API
# ============================================================================

@router.post("/events", response_model=EventResponse, status_code=status.HTTP_201_CREATED)
def create_event(
    request: EventCreateRequest,
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
    membership_service: MembershipService = Depends(get_membership_service),
) -> EventResponse:
    """
    이벤트 생성 API
    - event, options, assumptions, criteria를 한 번에 생성
    """
    # 1. 이벤트 생성
    event = event_service.create_event(request, admin_id=current_user.id)
    
    # 2. 선택지들 연결
    if request.options:
        event_service.attach_options(event.id, request.options, created_by=current_user.id)
    
    # 3. 전제들 연결
    if request.assumptions:
        event_service.attach_assumptions(event.id, request.assumptions, created_by=current_user.id)
    
    # 4. 기준들 연결
    if request.criteria:
        event_service.attach_criteria(event.id, request.criteria, created_by=current_user.id)
    
    # 5. 멤버십 생성
    membership_service.create_admin_membership(event.id, current_user.id)

    return EventResponse.model_validate(event)


@router.post("/events/entrance-code/check", response_model=EntranceCodeCheckResponse)
def check_entrance_code(
    request: EntranceCodeCheckRequest,
    event_service: EventService = Depends(get_event_service),
) -> EntranceCodeCheckResponse:
    """
    입장 코드 중복 확인 API
    - 중복이 없으면 is_available=True 반환
    """
    is_available = event_service.check_entrance_code_availability(request.entrance_code)
    return EntranceCodeCheckResponse(
        entrance_code=request.entrance_code,
        is_available=is_available,
    )


@router.get("/events/entrance-code/generate", response_model=EntranceCodeGenerateResponse)
def generate_entrance_code(
    event_service: EventService = Depends(get_event_service),
) -> EntranceCodeGenerateResponse:
    """
    랜덤 입장 코드 생성 API
    - 중복 검사 후 사용 가능한 코드 반환
    """
    code = event_service.get_random_code()
    return EntranceCodeGenerateResponse(code=code)


# ============================================================================
# Event_Overview (3-1-0) 관련 API
# ============================================================================

@router.post("/events/entry", response_model=EventEntryResponse, status_code=status.HTTP_201_CREATED)
def join_event_by_code(
    request: EntranceCodeEntryRequest,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
) -> EventEntryResponse:
    """
    이벤트 입장 API (코드로 참가 요청)
    - entrance_code로 이벤트 조회
    - 이미 멤버십이 있으면 에러
    - 없으면 PENDING 상태로 멤버십 생성
    """
    event_id, message = membership_service.join_event_by_code(
        entrance_code=request.entrance_code,
        user_id=current_user.id
    )
    return EventEntryResponse(
        message=message,
        event_id=event_id
    )


@router.get("/events/{event_id}/overview", response_model=EventOverviewResponse)
def get_event_overview(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
) -> EventOverviewResponse:
    """
    이벤트 오버뷰 정보 조회 API
    - event, options, admin, participant_count, membership_status, can_enter 반환
    """
    return event_service.get_event_overview(
        event_id=event_id,
        user_id=current_user.id
    )


# ============================================================================
# Event (4-0-0) 관련 API
# ============================================================================

@router.get("/events/{event_id}", response_model=EventDetailResponse)
def get_event_detail(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
) -> EventDetailResponse:
    """
    이벤트 상세 조회 API (Event 4-0-0 페이지용)
    - 주제, 선택지, 전제, 기준, 각각에 대한 제안 조회
    - 각 제안에 대한 투표 정보 포함
    - ACCEPTED 멤버십만 조회 가능
    """
    return event_service.get_event_detail(
        event_id=event_id,
        user_id=current_user.id
    )
@router.post(
    "/events/{event_id}/assumption-proposals",
    response_model=AssumptionProposalResponse,
    status_code=status.HTTP_201_CREATED
)
def create_assumption_proposal(
    event_id: UUID,
    request: AssumptionProposalCreateRequest,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> AssumptionProposalResponse:
    """
    전제 제안 생성 API
    - IN_PROGRESS 상태에서만 가능
    - ACCEPTED 멤버십 필요
    """
    return proposal_service.create_assumption_proposal(
        event_id=event_id,
        request=request,
        user_id=current_user.id
    )


@router.post(
    "/events/{event_id}/assumption-proposals/{proposal_id}/votes",
    response_model=AssumptionProposalVoteResponse,
    status_code=status.HTTP_201_CREATED
)
def create_assumption_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> AssumptionProposalVoteResponse:
    """
    전제 제안 투표 생성 API
    - IN_PROGRESS 상태에서만 가능
    - PENDING 제안에만 투표 가능
    """
    return proposal_service.create_assumption_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


@router.delete(
    "/events/{event_id}/assumption-proposals/{proposal_id}/votes",
    response_model=AssumptionProposalVoteResponse
)
def delete_assumption_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> AssumptionProposalVoteResponse:
    """
    전제 제안 투표 삭제 API
    - IN_PROGRESS 상태에서만 가능
    - 본인 투표만 삭제 가능
    """
    return proposal_service.delete_assumption_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


@router.post(
    "/events/{event_id}/criteria-proposals",
    response_model=CriteriaProposalResponse,
    status_code=status.HTTP_201_CREATED
)
def create_criteria_proposal(
    event_id: UUID,
    request: CriteriaProposalCreateRequest,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> CriteriaProposalResponse:
    """
    기준 제안 생성 API
    - IN_PROGRESS 상태에서만 가능
    - ACCEPTED 멤버십 필요
    """
    return proposal_service.create_criteria_proposal(
        event_id=event_id,
        request=request,
        user_id=current_user.id
    )


@router.post(
    "/events/{event_id}/criteria-proposals/{proposal_id}/votes",
    response_model=CriteriaProposalVoteResponse,
    status_code=status.HTTP_201_CREATED
)
def create_criteria_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> CriteriaProposalVoteResponse:
    """
    기준 제안 투표 생성 API
    - IN_PROGRESS 상태에서만 가능
    - PENDING 제안에만 투표 가능
    """
    return proposal_service.create_criteria_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


@router.delete(
    "/events/{event_id}/criteria-proposals/{proposal_id}/votes",
    response_model=CriteriaProposalVoteResponse
)
def delete_criteria_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> CriteriaProposalVoteResponse:
    """
    기준 제안 투표 삭제 API
    - IN_PROGRESS 상태에서만 가능
    - 본인 투표만 삭제 가능
    """
    return proposal_service.delete_criteria_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


@router.post(
    "/events/{event_id}/criteria/{criterion_id}/conclusion-proposals",
    response_model=ConclusionProposalResponse,
    status_code=status.HTTP_201_CREATED
)
def create_conclusion_proposal(
    event_id: UUID,
    criterion_id: UUID,
    request: ConclusionProposalCreateRequest,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> ConclusionProposalResponse:
    """
    결론 제안 생성 API
    - IN_PROGRESS 상태에서만 가능
    - ACCEPTED 멤버십 필요
    """
    return proposal_service.create_conclusion_proposal(
        event_id=event_id,
        criterion_id=criterion_id,
        request=request,
        user_id=current_user.id
    )


@router.post(
    "/events/{event_id}/conclusion-proposals/{proposal_id}/votes",
    response_model=ConclusionProposalVoteResponse,
    status_code=status.HTTP_201_CREATED
)
def create_conclusion_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> ConclusionProposalVoteResponse:
    """
    결론 제안 투표 생성 API
    - IN_PROGRESS 상태에서만 가능
    - PENDING 제안에만 투표 가능
    """
    return proposal_service.create_conclusion_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


@router.delete(
    "/events/{event_id}/conclusion-proposals/{proposal_id}/votes",
    response_model=ConclusionProposalVoteResponse
)
def delete_conclusion_proposal_vote(
    event_id: UUID,
    proposal_id: UUID,
    current_user: User = Depends(get_current_user),
    proposal_service: ProposalService = Depends(get_proposal_service),
) -> ConclusionProposalVoteResponse:
    """
    결론 제안 투표 삭제 API
    - IN_PROGRESS 상태에서만 가능
    - 본인 투표만 삭제 가능
    """
    return proposal_service.delete_conclusion_proposal_vote(
        event_id=event_id,
        proposal_id=proposal_id,
        user_id=current_user.id
    )


# TODO: GET /events/{event_id}/criteria/{criterion_id}/comments - 코멘트 조회
# TODO: POST /events/{event_id}/criteria/{criterion_id}/comments - 코멘트 생성
# TODO: PATCH /events/{event_id}/comments/{comment_id} - 코멘트 수정
# TODO: DELETE /events/{event_id}/comments/{comment_id} - 코멘트 삭제


# ============================================================================
# Event_Setting (4-1-0) 관련 API
# ============================================================================

@router.get("/events/{event_id}/setting", response_model=EventSettingResponse)
def get_event_setting(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
) -> EventSettingResponse:
    """
    이벤트 설정 편집용 정보 조회 API (관리자용)
    - 수정하기 위해 보여줘야 할 정보 반환
    - overview와 유사하지만 편집을 위한 모든 정보 포함
    """
    return event_service.get_event_setting(
        event_id=event_id,
        user_id=current_user.id
    )


@router.patch("/events/{event_id}", response_model=EventResponse)
def update_event(
    event_id: UUID,
    request: EventUpdateRequest,
    current_user: User = Depends(get_current_user),
    event_service: EventService = Depends(get_event_service),
) -> EventResponse:
    """
    이벤트 설정 수정 API (관리자용)
    - 기본 정보 (except 최대 인원): NOT_STARTED인 경우만 수정 가능
    - 최대 인원: FINISHED가 아닐 때 수정 가능 (현재 인원보다 작을 수 없음)
    - 투표 허용 정책 + 입장 정책: FINISHED가 아닐 때 수정 가능
    """
    event = event_service.update_event(
        event_id=event_id,
        request=request,
        user_id=current_user.id
    )
    return EventResponse.model_validate(event)


@router.patch(
    "/events/{event_id}/memberships/{membership_id}/approve",
    response_model=MembershipResponse
)
def approve_membership(
    event_id: UUID,
    membership_id: UUID,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
) -> MembershipResponse:
    """
    특정 참가자 참가 승인 API (관리자용)
    - membership_status를 PENDING에서 ACCEPTED로 변경
    - max_membership 초과 시 에러
    """
    membership = membership_service.approve_membership(
        event_id=event_id,
        membership_id=membership_id,
        user_id=current_user.id
    )
    return MembershipResponse(
        message="Membership approved successfully",
        membership_id=membership.id,
        membership_status=membership.membership_status,
    )


@router.patch(
    "/events/{event_id}/memberships/{membership_id}/reject",
    response_model=MembershipResponse
)
def reject_membership(
    event_id: UUID,
    membership_id: UUID,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
) -> MembershipResponse:
    """
    특정 참가자 참가 거부 API (관리자용)
    - membership_status를 PENDING에서 REJECTED로 변경
    """
    membership = membership_service.reject_membership(
        event_id=event_id,
        membership_id=membership_id,
        user_id=current_user.id
    )
    return MembershipResponse(
        message="Membership rejected successfully",
        membership_id=membership.id,
        membership_status=membership.membership_status,
    )


@router.post(
    "/events/{event_id}/memberships/bulk-approve",
    response_model=BulkMembershipResponse
)
def bulk_approve_memberships(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
) -> BulkMembershipResponse:
    """
    신청한 참가자 전부 참가 승인 API (관리자용)
    - PENDING 상태인 모든 멤버십을 ACCEPTED로 변경
    - max_membership 초과 시 실패 처리
    """
    result = membership_service.bulk_approve_memberships(
        event_id=event_id,
        user_id=current_user.id
    )
    return BulkMembershipResponse(
        message="Bulk approval completed",
        approved_count=result["approved_count"],
        failed_count=result["failed_count"],
    )


@router.post(
    "/events/{event_id}/memberships/bulk-reject",
    response_model=BulkMembershipResponse
)
def bulk_reject_memberships(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
) -> BulkMembershipResponse:
    """
    신청한 참가자 전부 참가 거부 API (관리자용)
    - PENDING 상태인 모든 멤버십을 REJECTED로 변경
    """
    result = membership_service.bulk_reject_memberships(
        event_id=event_id,
        user_id=current_user.id
    )
    return BulkMembershipResponse(
        message="Bulk rejection completed",
        rejected_count=result["rejected_count"],
    )


@router.get(
    "/events/{event_id}/memberships",
    response_model=List[MembershipListItemResponse]
)
def get_event_memberships(
    event_id: UUID,
    current_user: User = Depends(get_current_user),
    membership_service: MembershipService = Depends(get_membership_service),
    event_service: EventService = Depends(get_event_service),
) -> List[MembershipListItemResponse]:
    """
    이벤트의 모든 멤버십 목록 조회 API (관리자용)
    - 현재 참가신청된 사용자 정보 (status와 무관하게 전부)
    - user_id, membership_id, status, 신청 일시(created_at), 승인 일시(joined_at), is_me, is_admin 반환
    """
    # 관리자 권한 확인을 위해 이벤트 조회 (admin_id 확인용)
    event = event_service.verify_admin(event_id, current_user.id)
    
    # 멤버십 목록 조회
    memberships = membership_service.get_event_memberships(
        event_id=event_id,
        user_id=current_user.id
    )
    
    return [
        MembershipListItemResponse(
            user_id=membership.user_id,
            membership_id=membership.id,
            status=membership.membership_status,
            created_at=membership.created_at,
            joined_at=membership.joined_at,
            is_me=membership.user_id == current_user.id,
            is_admin=membership.user_id == event.admin_id,
        )
        for membership in memberships
    ]


# ============================================================================
# Event_Vote (4-2-0) 관련 API
# ============================================================================

# TODO: GET /events/{event_id}/votes/me - 본인 투표 내역 조회
# TODO: POST /events/{event_id}/votes - 투표 생성/업데이트


# ============================================================================
# Event_Comment 관련 API
# ============================================================================

@router.get(
    "/events/{event_id}/criteria/{criterion_id}/comments/count",
    response_model=CommentCountResponse
)
def get_comment_count(
    event_id: UUID,
    criterion_id: UUID,
    current_user: User = Depends(get_current_user),
    comment_service: CommentService = Depends(get_comment_service),
) -> CommentCountResponse:
    """
    특정 기준에 대한 코멘트 수 조회 API
    - 이벤트 멤버십이 ACCEPTED 상태인 사용자만 조회 가능
    """
    count = comment_service.get_comment_count(
        event_id=event_id,
        criterion_id=criterion_id,
        user_id=current_user.id
    )
    return CommentCountResponse(count=count)


@router.get(
    "/events/{event_id}/criteria/{criterion_id}/comments",
    response_model=List[CommentResponse]
)
def get_comments(
    event_id: UUID,
    criterion_id: UUID,
    current_user: User = Depends(get_current_user),
    comment_service: CommentService = Depends(get_comment_service),
) -> List[CommentResponse]:
    """
    특정 기준에 대한 코멘트 목록 조회 API
    - 이벤트 멤버십이 ACCEPTED 상태인 사용자만 조회 가능
    - 작성자 정보 포함
    """
    comments = comment_service.get_comments(
        event_id=event_id,
        criterion_id=criterion_id,
        user_id=current_user.id
    )
    return [
        CommentResponse(
            id=comment.id,
            criterion_id=comment.criterion_id,
            content=comment.content,
            created_at=comment.created_at,
            updated_at=comment.updated_at,
            created_by=comment.created_by,
            creator=CommentCreatorInfo(
                id=comment.creator.id,
                name=comment.creator.name,
                email=comment.creator.email
            ) if comment.creator else None
        )
        for comment in comments
    ]


@router.post(
    "/events/{event_id}/criteria/{criterion_id}/comments",
    response_model=CommentResponse,
    status_code=status.HTTP_201_CREATED
)
def create_comment(
    event_id: UUID,
    criterion_id: UUID,
    request: CommentCreateRequest,
    current_user: User = Depends(get_current_user),
    comment_service: CommentService = Depends(get_comment_service),
) -> CommentResponse:
    """
    코멘트 생성 API
    - 이벤트 멤버십이 ACCEPTED 상태인 사용자만 생성 가능
    """
    comment = comment_service.create_comment(
        event_id=event_id,
        criterion_id=criterion_id,
        content=request.content,
        user_id=current_user.id
    )
    return CommentResponse(
        id=comment.id,
        criterion_id=comment.criterion_id,
        content=comment.content,
        created_at=comment.created_at,
        updated_at=comment.updated_at,
        created_by=comment.created_by,
        creator=CommentCreatorInfo(
            id=comment.creator.id,
            name=comment.creator.name,
            email=comment.creator.email
        ) if comment.creator else None
    )


@router.patch(
    "/events/{event_id}/comments/{comment_id}",
    response_model=CommentResponse
)
def update_comment(
    event_id: UUID,
    comment_id: UUID,
    request: CommentUpdateRequest,
    current_user: User = Depends(get_current_user),
    comment_service: CommentService = Depends(get_comment_service),
) -> CommentResponse:
    """
    코멘트 수정 API
    - 이벤트 멤버십이 ACCEPTED 상태인 사용자만 수정 가능
    - 본인이 작성한 코멘트만 수정 가능
    """
    comment = comment_service.update_comment(
        event_id=event_id,
        comment_id=comment_id,
        content=request.content,
        user_id=current_user.id
    )
    return CommentResponse(
        id=comment.id,
        criterion_id=comment.criterion_id,
        content=comment.content,
        created_at=comment.created_at,
        updated_at=comment.updated_at,
        created_by=comment.created_by,
        creator=CommentCreatorInfo(
            id=comment.creator.id,
            name=comment.creator.name,
            email=comment.creator.email
        ) if comment.creator else None
    )


@router.delete(
    "/events/{event_id}/comments/{comment_id}",
    status_code=status.HTTP_204_NO_CONTENT
)
def delete_comment(
    event_id: UUID,
    comment_id: UUID,
    current_user: User = Depends(get_current_user),
    comment_service: CommentService = Depends(get_comment_service),
) -> None:
    """
    코멘트 삭제 API
    - 이벤트 멤버십이 ACCEPTED 상태인 사용자만 삭제 가능
    - 본인이 작성한 코멘트만 삭제 가능
    """
    comment_service.delete_comment(
        event_id=event_id,
        comment_id=comment_id,
        user_id=current_user.id
    )



